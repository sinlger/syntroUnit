---
export const prerender = false;
import BaseLayout from "@/layouts/BaseLayout.astro";
import { Breadcrumbs } from "@/components/react/Breadcrumbs";
import { UnitConverter } from "@/components/react/UnitConverter";
import { UnitNavigation } from "@/components/react/UnitNavigation";
import { RecentConversions } from "@/components/react/RecentConversions";
import { RandomUnitConversions } from "@/components/react/RandomUnitConversions";
import { ConversionTable } from "@/components/react/ConversionTable";
import { languages, ui } from "@/i18n/ui";
import { useTranslations } from "@/i18n/utils";

// Set cache headers for Cloudflare and Browser
// Browser: 1 hour (3600s)
// CDN (Cloudflare): 7 days (604800s)
Astro.response.headers.set('Cache-Control', 'public, max-age=3600, s-maxage=604800');

const { lang, unit, subunit, conversion } = Astro.params;

// Parse dynamic params
let sourceId = '';
let targetId = '';
let value = '';

if (subunit && conversion && conversion.endsWith(subunit)) {
  const parts = subunit.split('-to-');
  if (parts.length === 2) {
     [sourceId, targetId] = parts;
     const suffix = subunit;
     if (conversion.endsWith(suffix)) {
        value = conversion.slice(0, -suffix.length);
     }
  }
}

if (!sourceId || !targetId || !value || isNaN(Number(value))) {
  return Astro.redirect(`/${lang || 'en'}/${unit || 'length'}`);
}

// Load data using eager glob to ensure Vite handles it correctly
const unitFiles = import.meta.glob("../../../../unit/*.json", { eager: true });
const langFiles = import.meta.glob("../../../../i18n/lang/*.json", {
  eager: true,
});
const subunitFiles = import.meta.glob('../../../../subunit/**/*.json', { eager: true });

const unitData = (unitFiles[`../../../../unit/${unit}.json`] as { default: any } | undefined)?.default || {};
const langModule = langFiles[`../../../../i18n/lang/${lang}.json`] as { default: any } | undefined;
const t = langModule?.default || {};

// Load subunit specific info
const subunitPath = `../../../../subunit/${lang}/${unit}.json`;
const subunitData = (subunitFiles[subunitPath] as { default: any } | undefined)?.default || [];
const sourceInfo = Array.isArray(subunitData) ? subunitData.find(u => u.symbol === sourceId) : null;
const targetInfo = Array.isArray(subunitData) ? subunitData.find(u => u.symbol === targetId) : null;

let allUnits = [];
if (Array.isArray(unitData)) {
  allUnits = unitData.flatMap(g => g.units || []);
} else {
  if (unitData.groups) allUnits = allUnits.concat(unitData.groups.flatMap(g => g.units || []));
  if (unitData.units) allUnits = allUnits.concat(unitData.units || []);
}

// Filter out invalid units
allUnits = allUnits.filter(u => u && u.id);

const sourceUnitObj = allUnits.find(u => u.id === sourceId);
const targetUnitObj = allUnits.find(u => u.id === targetId);

if (!sourceUnitObj || !targetUnitObj) {
  return Astro.redirect(`/${lang || 'en'}/${unit || 'length'}`);
}

// Prepare translations for the current unit type
const unitTranslations = {};
if (t[unit]) {
  if (t[unit].groups) {
    Object.assign(unitTranslations, t[unit].groups);
  }
  if (t[unit].units) {
    Object.assign(unitTranslations, t[unit].units);
  }
}

const unitTitle =
  t[unit]?.title || unit.charAt(0).toUpperCase() + unit.slice(1);

const navTranslations = {};
const allUnitTranslations = {};
Object.keys(t).forEach(k => {
  if (t[k]?.title) {
    navTranslations[k] = t[k].title;
  }
  if (t[k]?.units) {
    Object.assign(allUnitTranslations, t[k].units);
  }
  if (t[k]?.groups) {
    Object.assign(allUnitTranslations, t[k].groups);
  }
});

const t_ui = useTranslations(lang as keyof typeof ui);

const recentTranslations = {
  title: t_ui('components.recent_conversions.title'),
  noHistory: t_ui('components.recent_conversions.no_history'),
  clearHistory: t_ui('components.recent_conversions.clear_history'),
  equalsHowMany: t_ui('components.recent_conversions.equals_how_many'),
};

const unitConverterTranslations = {
  description: t_ui('components.unit_converter.description'),
  inputPlaceholder: t_ui('components.unit_converter.input_placeholder'),
  inputLabel: t_ui('components.unit_converter.input_label'),
  inputTitle: t_ui('components.unit_converter.input_title'),
  selectSourceLabel: t_ui('components.unit_converter.select_source_label'),
  selectSourceTitle: t_ui('components.unit_converter.select_source_title'),
  swapButtonLabel: t_ui('components.unit_converter.swap_button_label'),
  swapButtonTitle: t_ui('components.unit_converter.swap_button_title'),
  selectTargetLabel: t_ui('components.unit_converter.select_target_label'),
  selectTargetTitle: t_ui('components.unit_converter.select_target_title'),
  convertButtonLabel: t_ui('components.unit_converter.convert_button_label'),
  convertButtonTitle: t_ui('components.unit_converter.convert_button_title'),
  convertButtonText: t_ui('components.unit_converter.convert_button_text'),
  resultLabel: t_ui('components.unit_converter.result_label'),
  processTitle: t_ui('components.unit_converter.process_title'),
  formulaTitle: t_ui('components.unit_converter.formula_title'),
  formulaStep1Desc: t_ui('components.unit_converter.formula_step1_desc'),
  formulaStep2Desc: t_ui('components.unit_converter.formula_step2_desc'),
  step1Title: t_ui('components.unit_converter.step1_title'),
  step1Formula: t_ui('components.unit_converter.step1_formula'),
  step1Calc: t_ui('components.unit_converter.step1_calc'),
  step2Title: t_ui('components.unit_converter.step2_title'),
  step2Formula: t_ui('components.unit_converter.step2_formula'),
  step2Calc: t_ui('components.unit_converter.step2_calc'),
  resultText: t_ui('components.unit_converter.result_text'),
  baseUnitDefault: t_ui('components.unit_converter.base_unit_default'),
  supportedUnitsLabel: t_ui('components.unit_converter.supported_units_label'),
};

const sourceName = unitTranslations[sourceId] || sourceId;
const targetName = unitTranslations[targetId] || targetId;
const subTitle = `${sourceName} - ${targetName}`;
const conversionTitle = `${value} ${sourceName} ${recentTranslations.equalsHowMany} ${targetName}`;
const pageDescription = `Convert ${value} ${sourceName} to ${targetName} easily. ${sourceInfo?.intro || ''} ${targetInfo?.intro || ''}`.trim();
---

<BaseLayout title={conversionTitle} description={pageDescription}>
  <div class="container mx-auto max-w-6xl px-4 py-8">
    <Breadcrumbs
      items={[
        { label: "Home", href: `/${lang}` },
        { label: unitTitle, href: `/${lang}/${unit}` },
        { label: subTitle, href: `/${lang}/${unit}/${subunit}` },
        { label: conversionTitle }
      ]}
    />

    <div class="grid gap-8 lg:grid-cols-12 items-start mt-6">
      <div class="lg:col-span-9">
        <UnitConverter
          client:load
          data={unitData}
          unitType={unit}
          translations={unitTranslations}
          title={conversionTitle}
          uiTranslations={unitConverterTranslations}
          defaultSourceUnit={sourceId}
          defaultTargetUnit={targetId}
          defaultAmount={value}
          lang={lang}
        />

        {(sourceInfo || targetInfo) && (
          <div class="grid md:grid-cols-2 gap-5 mt-5">
            {sourceInfo && (
              <div class="bg-white dark:bg-zinc-900 p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-zinc-800">
                <h3 class="text-lg font-semibold mb-2 text-slate-800 dark:text-slate-100">{sourceInfo.name} ({sourceInfo.symbol})</h3>
                <p class="text-slate-600 dark:text-slate-400 text-sm mb-3 leading-relaxed">{sourceInfo.intro}</p>
                <div class="bg-slate-50 dark:bg-zinc-950/50 px-3 py-2 rounded-lg border border-slate-100 dark:border-zinc-800">
                   <p class="text-xs text-slate-500 dark:text-slate-500 font-mono">{sourceInfo.conversion}</p>
                </div>
              </div>
            )}
            {targetInfo && (
              <div class="bg-white dark:bg-zinc-900 p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-zinc-800">
                <h3 class="text-lg font-semibold mb-2 text-slate-800 dark:text-slate-100">{targetInfo.name} ({targetInfo.symbol})</h3>
                <p class="text-slate-600 dark:text-slate-400 text-sm mb-3 leading-relaxed">{targetInfo.intro}</p>
                <div class="bg-slate-50 dark:bg-zinc-950/50 px-3 py-2 rounded-lg border border-slate-100 dark:border-zinc-800">
                   <p class="text-xs text-slate-500 dark:text-slate-500 font-mono">{targetInfo.conversion}</p>
                </div>
              </div>
            )}
          </div>
        )}

        <div class="mt-5">
          <ConversionTable
          client:load
          sourceUnit={sourceUnitObj}
          targetUnit={targetUnitObj}
          lang={lang}
          translations={unitTranslations}
          title={t_ui('components.conversion_table.title')}
          unitType={unit}
        />
        </div>
        <div class="mt-5">
          <RandomUnitConversions
            client:load
            data={unitData}
            unitType={unit}
            lang={lang}
            translations={unitTranslations}
            title={t_ui('components.random_conversions.title')}
            conversionFormat={t_ui('components.random_conversions.link_format')}
          />
        </div>
      </div>
      <div class="lg:col-span-3 space-y-5">
        <RecentConversions client:load translations={recentTranslations} unitTranslations={allUnitTranslations} lang={lang} unitType={unit} />
        <div class="mt-5">
          <UnitNavigation
            client:load
            lang={lang}
            currentUnit={unit}
            translations={navTranslations}
            title={t_ui('components.unit_navigation.title')}
          />
        </div>
      </div>
    </div>
  </div>
</BaseLayout>
