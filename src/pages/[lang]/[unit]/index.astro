---
import BaseLayout from "@/layouts/BaseLayout.astro";
import { Breadcrumbs } from "@/components/react/Breadcrumbs";
import { UnitConverter } from "@/components/react/UnitConverter";
import { RecentConversions } from "@/components/react/RecentConversions";
import { languages, ui } from "@/i18n/ui";

export async function getStaticPaths() {
  const unitFiles = import.meta.glob('../../../unit/*.json');
  const units = Object.keys(unitFiles).map(path => {
    const fileName = path.split('/').pop();
    return fileName.replace('.json', '');
  });

  return Object.keys(languages).flatMap((lang) =>
    units.map((unit) => ({
      params: { lang, unit },
    }))
  );
}

const { lang, unit } = Astro.params;

// Load data using eager glob to ensure Vite handles it correctly
const unitFiles = import.meta.glob('../../../unit/*.json', { eager: true });
const langFiles = import.meta.glob('../../../i18n/lang/*.json', { eager: true });

const unitData = unitFiles[`../../../unit/${unit}.json`]?.default || {};
const t = langFiles[`../../../i18n/lang/${lang}.json`]?.default || {};

// Prepare translations for the current unit type
// Flatten the structure: { "length.groups.metric": "Metric", "length.units.m": "Meter" } -> { "metric": "Metric", "m": "Meter" }
// Assuming t structure matches unitData structure roughly
// t[unit] contains { groups: {...}, units: {...} }
const unitTranslations = {};
if (t[unit]) {
  if (t[unit].groups) {
    Object.assign(unitTranslations, t[unit].groups);
  }
  if (t[unit].units) {
    Object.assign(unitTranslations, t[unit].units);
  }
}

const unitTitle = t[unit]?.title || (unit.charAt(0).toUpperCase() + unit.slice(1));
---

<BaseLayout>
    <div class="container mx-auto max-w-7xl px-4 py-8">
        <Breadcrumbs items={[
            { label: "Home", href: `/${lang}` },
            { label: unitTitle }
        ]} />        
        
        <div class="grid gap-8 lg:grid-cols-12 items-start mt-6">
            <div class="lg:col-span-8">
                <UnitConverter 
                    client:load 
                    data={unitData} 
                    unitType={unit} 
                    translations={unitTranslations}
                    title={unitTitle}
                />
            </div>
            <div class="lg:col-span-4 space-y-6">
                <RecentConversions client:load />
            </div>
        </div>
    </div>
</BaseLayout>
