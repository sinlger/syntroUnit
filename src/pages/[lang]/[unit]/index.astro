---
export const prerender = true;
import BaseLayout from "@/layouts/BaseLayout.astro";
import { Breadcrumbs } from "@/components/react/Breadcrumbs";
import { UnitConverter } from "@/components/react/UnitConverter";
import { UnitNavigation } from "@/components/react/UnitNavigation";
import { RecentConversions } from "@/components/react/RecentConversions";
import { RandomUnitConversions } from "@/components/react/RandomUnitConversions";
import { languages, ui } from "@/i18n/ui";
import { useTranslations } from "@/i18n/utils";

export async function getStaticPaths() {
  const unitFiles = import.meta.glob("../../../unit/*.json");
  const units = Object.keys(unitFiles).map((path) => {
    const fileName = path.split("/").pop();
    return fileName.replace(".json", "");
  }).filter(unit => unit !== 'ring');

  return Object.keys(languages).flatMap((lang) =>
    units.map((unit) => ({
      params: { lang, unit },
    })),
  );
}

const { lang, unit } = Astro.params;

// Load data using eager glob to ensure Vite handles it correctly
const unitFiles = import.meta.glob("../../../unit/*.json", { eager: true });
const langFiles = import.meta.glob("../../../i18n/lang/*.json", {
  eager: true,
});
// Dynamically load unit context markdown files
const contextFiles = import.meta.glob('../../../unitcontext/**/*.md', { eager: true });

const unitData = (unitFiles[`../../../unit/${unit}.json`] as any)?.default || {};
const t = (langFiles[`../../../i18n/lang/${lang}.json`] as any)?.default || {};

// Try to find matching markdown content
// Path pattern: src/unitcontext/[lang]/[unit].md
const contextPath = `../../../unitcontext/${lang}/${unit}.md`;
const contextModule = contextFiles[contextPath];
const ContextContent = contextModule ? (contextModule as any).Content : null;
const contextFrontmatter = contextModule ? (contextModule as any).frontmatter || {} : {};

// Prepare translations for the current unit type
// Flatten the structure: { "length.groups.metric": "Metric", "length.units.m": "Meter" } -> { "metric": "Metric", "m": "Meter" }
// Assuming t structure matches unitData structure roughly
// t[unit] contains { groups: {...}, units: {...} }
const unitTranslations = {};
if (t[unit]) {
  if (t[unit].groups) {
    Object.assign(unitTranslations, t[unit].groups);
  }
  if (t[unit].units) {
    Object.assign(unitTranslations, t[unit].units);
  }
}
const t_ui = useTranslations(lang as keyof typeof ui);

const unitConverterTranslations = {
  description: t_ui('components.unit_converter.description'),
  inputPlaceholder: t_ui('components.unit_converter.input_placeholder'),
  inputLabel: t_ui('components.unit_converter.input_label'),
  inputTitle: t_ui('components.unit_converter.input_title'),
  selectSourceLabel: t_ui('components.unit_converter.select_source_label'),
  selectSourceTitle: t_ui('components.unit_converter.select_source_title'),
  swapButtonLabel: t_ui('components.unit_converter.swap_button_label'),
  swapButtonTitle: t_ui('components.unit_converter.swap_button_title'),
  selectTargetLabel: t_ui('components.unit_converter.select_target_label'),
  selectTargetTitle: t_ui('components.unit_converter.select_target_title'),
  convertButtonLabel: t_ui('components.unit_converter.convert_button_label'),
  convertButtonTitle: t_ui('components.unit_converter.convert_button_title'),
  convertButtonText: t_ui('components.unit_converter.convert_button_text'),
  resultLabel: t_ui('components.unit_converter.result_label'),
  processTitle: t_ui('components.unit_converter.process_title'),
  formulaTitle: t_ui('components.unit_converter.formula_title'),
  formulaStep1Desc: t_ui('components.unit_converter.formula_step1_desc'),
  formulaStep2Desc: t_ui('components.unit_converter.formula_step2_desc'),
  step1Title: t_ui('components.unit_converter.step1_title'),
  step1Formula: t_ui('components.unit_converter.step1_formula'),
  step1Calc: t_ui('components.unit_converter.step1_calc'),
  step2Title: t_ui('components.unit_converter.step2_title'),
  step2Formula: t_ui('components.unit_converter.step2_formula'),
  step2Calc: t_ui('components.unit_converter.step2_calc'),
  resultText: t_ui('components.unit_converter.result_text'),
  baseUnitDefault: t_ui('components.unit_converter.base_unit_default'),
  supportedUnitsLabel: t_ui('components.unit_converter.supported_units_label'),
};

const shortTitle = t[unit]?.title || unit.charAt(0).toUpperCase() + unit.slice(1);
const unitTitle =
  contextFrontmatter.title || shortTitle;
const pageDescription = contextFrontmatter.description || unitConverterTranslations.description;
const pageKeywords = contextFrontmatter.keywords;

const navTranslations = {};
const allUnitTranslations = {};
Object.keys(t).forEach(k => {
  if (t[k]?.title) {
    navTranslations[k] = t[k].title;
  }
  if (t[k]?.units) {
    Object.assign(allUnitTranslations, t[k].units);
  }
  if (t[k]?.groups) {
    Object.assign(allUnitTranslations, t[k].groups);
  }
});

const recentTranslations = {
  title: t_ui('components.recent_conversions.title'),
  noHistory: t_ui('components.recent_conversions.no_history'),
  clearHistory: t_ui('components.recent_conversions.clear_history'),
  equalsHowMany: t_ui('components.recent_conversions.equals_how_many'),
};
---

<BaseLayout>
  <div class="container mx-auto max-w-6xl px-4 py-8">
    <Breadcrumbs
      items={[{ label: "Home", href: `/${lang}` }, { label: shortTitle }]}
    />

    <div class="grid gap-8 lg:grid-cols-12 items-start mt-6">
      <div class="lg:col-span-9">
        <UnitConverter
          client:load
          data={unitData}
          unitType={unit}
          translations={unitTranslations}
          title={unitTitle}
          uiTranslations={unitConverterTranslations}
          lang={lang}
        />
        {ContextContent && (
          <div class="prose dark:prose-invert max-w-none mt-12 mb-8 bg-white dark:bg-zinc-900 p-8 rounded-2xl shadow-sm border border-slate-100 dark:border-zinc-800">
            <ContextContent />
          </div>
        )}
        <div class="mt-5">
          <RandomUnitConversions
            client:load
            data={unitData}
            unitType={unit}
            lang={lang}
            translations={unitTranslations}
            title={t_ui('components.random_conversions.title')}
            conversionFormat={t_ui('components.random_conversions.link_format')}
          />
        </div>
      </div>
      <div class="lg:col-span-3 space-y-5">
        <RecentConversions client:load translations={recentTranslations} unitTranslations={allUnitTranslations} lang={lang} unitType={unit} />
        <div class="mt-5">
          <UnitNavigation
            client:load
            lang={lang}
            currentUnit={unit}
            translations={navTranslations}
            title={t_ui('components.unit_navigation.title')}
          />
        </div>
      </div>
    </div>
  </div>
</BaseLayout>
